Simple Mail Transfer Protocol es un protocolo para enviar correos en redes IP. Usa la arquitectura de cliente-servidor. 

Puerto **25/TCP** --> SMTP clásico sin cifrar
Puerto **587/TCP** --> SMTP envío con autenticación
Puerto **465/TCP** --> SMTP cifrado


### Arquitectura

*MAIL USER AGENT*: Es el programa que envia el correo (Gmail, Outlook...)

*MAIL SUBMISSION AGENT*: Una puerta antes de salir que comprueba si estas autenticado y si puedes enviar correos

*MAIL TRANSFER AGENT*: Es el 'cartero', busca el servidor de correos MX y envia el correo de server a server.

*MAIL DELIVERY AGENT*: Recibe el correo del MTA y lo guarda en un buzon de usuario 

*BUZÓN*: Es un directorio o BBDD donde se accede a partir de otros protocolos de buzon como IMAP O POP3


### Comandos SMTP

| Comando         | Función                              |
| --------------- | ------------------------------------ |
| `HELO` / `EHLO` | Inicia sesión                        |
| `AUTH`          | Autenticación                        |
| `MAIL FROM`     | Remitente                            |
| `RCPT TO`       | Destinatario                         |
| `DATA`          | Contenido del email                  |
| `VRFY`          | Verifica usuarios (para enumeración) |
| `EXPN`          | Expande listas                       |
| `RSET`          | Cancela envío                        |
| `NOOP`          | Mantiene conexión                    |
| `QUIT`          | Cierra sesión                        |


### Enumeración

```
telnet {ip} {SMTP_port}

Trying 10.129.14.128...
Connected to 10.129.14.128.
Escape character is '^]'.
220 ESMTP Server 

EHLO {dominio}

VRFY root
```

Podemos interactuar con SMPT si usamos telnet y utilizar los comandos mencionados anteriormente. Pero para enumerar usuarios hay que tener cuidado porque muchos servidores devuelven 252 aunque el usuario **NO exista**.

### Open Relay

Es una configuracion que permite enviar correos sin autenticación

```
mynetworks = 0.0.0.0/0
```

Esta linea de configuracion significa que cualquier IP puede usar mi servidor para mandar correos.

con NMAP y los scripts generales **-sV** podemos detectar si es un servidor Open Relay o no.

