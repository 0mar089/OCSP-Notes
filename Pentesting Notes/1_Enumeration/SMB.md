SMB (Server Message Block) es un protocolo de red para compartir ficheros, impresoras y recursos en entornos Windows y entre Windows ↔ Unix (vía Samba).

SMB permite acceso a carpetas remotas (`\\HOST\share`) y es clave en movimiento lateral y exfiltración cuando está mal configurado.

## Puertos habituales

- **TCP 445** — SMB directo sobre TCP (actual).
- **TCP/UDP 137–139** — NetBIOS/SMB antiguas.


Debemos intentar listar archvios si no tenemos credenciales:

```
smbclient -N -L \\\\<host>
```

Mostrará si hay una lista de carpetas compartidas sin necesidad de un password. Esta carpeta compartida es como la hemos llamado antes `share` .

Si quieres acceder sin usuario y contraseña:

```
smbclient \\\\<host>\\<share>
```

Y podemos entrar y usar comandos


Si tienes usuario + password usuariamos este comando y a mas quieres acceder a la carpeta que encontraste antes:

```
smbclient -U <user> \\\\<host>\\<share>
```

Con este comando nos pedirá una contraseña si hace falta.

Luego puedes usar comandos basicos como **ls**, **cd**, **get**...


## Enumeración con otras herramientas

Una de las herramientas que podemos usar es **rpcclient**, que permite recorrer de manera "manual" la red SMB si se puede anonimamente, aunque se use esta herramienta.

```
Omi089@htb[/htb]$ rpcclient -U "" 10.129.14.128 
Enter WORKGROUP\'s password: 
rpcclient $>
```

```
rpcclient $> srvinfo # Server information.

rpcclient $> enumdomains # Enumerate all domains

rpcclient $> querydominfo # Provides information of deployed domains

rpcclient $> netshareenumall # Enumerates all available shares

rpcclient $> netsharegetinfo <share> Provides information about a specific share

rpcclient $> enumdomusers # Enumerates all domain users.

rpcclient $> queryuser <RID> # Provides information about a specific user
```


Con los comandos **enumdomusers** y **queryuser** podemos obtener bastante informacion incluido nombres de usuarios:

```
rpcclient $> enumdomusers 

user:[mrb3n] rid:[0x3e8] 
user:[cry0l1t3] rid:[0x3e9]

```

### SAMRDUMP

Con la herramienta de **Impacket** https://github.com/fortra/impacket, hay un script llaamdo **samrdump.py**. Permite tambien obtener toda esta informacion d emanera mas sencilla y visual a nivel de usuarios, grupos....

```
Omi089@htb[/htb]$ samrdump.py 10.129.14.128 

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation 
[*] Retrieving endpoint list from 10.129.14.128 
Found domain(s): 
. 
DEVSMB 
. Builtin 
[*] Looking up users in domain DEVSMB 
Found user: mrb3n, uid = 1000 
Found user: cry0l1t3, uid = 1001
...
```


### SmbMAP o CrackMapExec

Herramientas como **smbmap**  https://github.com/ShawnDEvans/smbmap  o  **CrackMapExec** https://github.com/byt3bl33d3r/CrackMapExec.git permiten enumerar carpetas, mapear shares, permisos. CrackMapExec es mucho mas completa y profesional ya que prueba por fuerza bruta unas credenciales, users, muestra mucha mas información. 

```
Omi089@htb[/htb]$ smbmap -H 10.129.14.128

Disk       Permissions  Comment
print$     NO ACCESS    Printer Drivers
home       NO ACCESS    INFREIGHT Samba
dev        NO ACCESS    DEVenv
notes      NO ACCESS    CheckIT
IPC$       NO ACCESS    IPC Service (DEVSM)
```
- **- H** para indicar el host


```
Omi089@htb[/htb]$ crackmapexec smb 10.129.14.128 --shares -u '' -p ''

SMB  10.129.14.128  445  DEVSMB  [+] Enumerated shares
Share   Permissions   Remark
notes   READ,WRITE    CheckIT
home    NO ACCESS     INFREIGHT Samba
print$  NO ACCESS     Printer Drivers
```

- **-u** para indicar el usuario
- **-p** para indicar la contraseña


### Enum4LInux

Otra herramienta de numeracion smb. Siempre esta bien tener mas de 2 herramientas por si las moscas
se instala primero:

```
Omi089@htb[/htb]$ git clone https://github.com/cddmp/enum4linux-ng.git Omi089@htb[/htb]$ cd enum4linux-ng 
Omi089@htb[/htb]$ pip3 install -r requirements.txt
```

Y luego se ejecuta pasandole la ip 
```
./enum4linux-ng.py 10.129.14.128 -A

========================== 
| Target Information |
==========================

[*] Target ........... 10.129.14.128
[*] Username ......... ''
[*] Random Username .. 'juzgtcsu'
[*] Password ......... ''
[*] Timeout .......... 5 second(s)


===================================== 
| Service Scan on 10.129.14.128 |
=====================================


[*] Checking LDAP
[-] Could not connect to LDAP on 389/tcp: connection refused
[*] Checking LDAPS
[-] Could not connect to LDAPS on 636/tcp: connection refused
[*] Checking SMB
[+] SMB is accessible on 445/tcp
[*] Checking SMB over NetBIOS
[+] SMB over NetBIOS is accessible on 139/tcp

...

```